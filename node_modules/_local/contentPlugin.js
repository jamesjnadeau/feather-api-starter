var async = require('async');
var loaderUtil = require('loader-utils');
var pathUtil = require('path');
var jade = require('jade');

//ensure that mongo is connected using env variables
var mongoose = require('_local/utils/mongoose');
var contentSchema = require('_local/models/content');
var mongooseService = require('feathers-mongoose');
var contentService = mongooseService('content', contentSchema, {connection: mongoose});

module.exports = function(source) {
  var self = this;
  //declare as cacheable
  self.cacheable();
  //declare as async and save function call for later
  var callback = self.async();

  //Template Pre-Compile
  var templatePath = __dirname+'/../../frontend/views/content.jade';
  this.addDependency(templatePath);
  var template = jade.compileFile(templatePath, {pretty: false});

  var runByWebpack = true;
  //This is not accutally used yet..... and might not ever be...
  if(typeof self.emitFile === 'undefined') {
    runByWebpack = false;
    //Not running from webpack, we need to define our own emitFile function to use later
    var webpackConfig = require('../webpack.config.js')[1];
    var buildPath = webpackConfig.output.path;
    self.emitFile = function(outputFileName, content) {
      var output_path = pathUtil.join(buildPath, outputFileName);
      console.log('output path', output_path);
      fs.writeSync(output_path, content);
    };
  }
  var count = 0;
  async.waterfall([
    function getAllContent(done) {
      contentService.find({}, done);
    },
    function processContent(results, done) {
      async.eachSeries(results, function(item, itemDone) {
        if(typeof item.relPath !== 'undefined') {
          var outputFileName = pathUtil.join(item.relPath, '/index.html')
            .replace(/^(\/|\\)/, ''); // Remove leading slashes for webpack-dev-server
          var content = template(item);
          self.emitFile(outputFileName, content);
          count++;
        }
        itemDone();
      }, done);
    }
  ], function allDone(err) {
    if(err) console.log(err);
    console.log('Content Processed', count);
    if(runByWebpack
      && pathUtil.basename(process.title) !== 'dev-frontend') {
      //when we are all done, disconnect mongoose
      mongoose.connection.close(function () {
        console.info('Webpacks use of mongoose disconnected');
      });
    } else {
      console.info('Not restarting mongoose because this is the dev server');
    }
    callback(null, source);
  });
};
