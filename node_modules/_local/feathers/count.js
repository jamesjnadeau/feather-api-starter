var filter = require('feathers-query-filters');
module.exports = function (self, model, req, res, next) {
  var params = req.params;
  params.query = params.query || {};
  var filters = filter(params.query);
  var query = self.model.count(params.query);
  if (filters.$select && filters.$select.length) {
    var fields = {};
    _.each(filters.$select, function(key){
      fields[key] = 1;
    });
    query.select(fields);
  }
  if (filters.$sort){
    query.sort(filters.$sort);
  }
  if (filters.$limit){
    query.limit(filters.$limit);
  }
  if (filters.$skip){
    query.skip(filters.$skip);
  }
  if (filters.$populate){
    query.populate(filters.$populate);
  }
  query.exec(function(error, data) {
    if (error) {
      return next(new errors.BadRequest(error));
    }

    res.json({count: data});
  });
};
